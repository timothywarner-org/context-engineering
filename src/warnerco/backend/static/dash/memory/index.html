<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory Learning | WARNERCO Robotics</title>
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
  <link rel="stylesheet" href="/dash/styles/global.css">
</head>
<body>
  <nav class="nav">
    <div class="nav-container">
      <a href="/dash/" class="nav-brand">
        <img src="/assets/warnerco-logo.svg" alt="WARNERCO" class="nav-logo">
      </a>
      <div class="nav-links">
        <a href="/dash/schematics/" class="nav-link">Schematics</a>
        <a href="/dash/memory/" class="nav-link active">Memory</a>
        <a href="/docs" class="nav-link" target="_blank">API Docs</a>
      </div>
    </div>
  </nav>

  <main class="container" style="padding: var(--space-xl) var(--space-lg);">
    <!-- Hero Section -->
    <div class="card mb-lg" style="background: linear-gradient(135deg, var(--bg-card) 0%, rgba(0,102,204,0.1) 100%);">
      <h1 style="margin-bottom: var(--space-sm);">Memory Architecture Learning Lab</h1>
      <p class="text-secondary" style="max-width: 800px; margin-bottom: 0;">
        Explore how WARNERCO Schematica uses a 3-tier memory architecture for retrieval-augmented generation (RAG).
        Watch real-time queries flow through JSON, vector embeddings, and semantic search layers.
      </p>
    </div>

    <!-- Stats Row -->
    <div class="grid grid-4 mb-lg" id="statsRow">
      <div class="stat-card">
        <div class="stat-value" id="totalDocs">-</div>
        <div class="stat-label">Total Documents</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="vectorDim">1536</div>
        <div class="stat-label">Vector Dimensions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgLatency">-</div>
        <div class="stat-label">Avg Query (ms)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="queryCount">0</div>
        <div class="stat-label">Queries This Session</div>
      </div>
    </div>

    <div class="grid grid-2 mb-lg">
      <!-- Memory Architecture Visualization -->
      <div class="card">
        <h2 style="margin-bottom: var(--space-lg);">3-Tier Memory Architecture</h2>
        <div class="memory-viz">
          <div class="memory-layer json" id="layerJson">
            <div class="memory-layer-icon" style="background: rgba(34, 197, 94, 0.2);">üìÑ</div>
            <div class="memory-layer-info">
              <div class="memory-layer-name">Layer 1: JSON Source</div>
              <div class="memory-layer-desc">Source of truth - structured schematic data</div>
            </div>
            <span class="badge badge-success" id="jsonStatus">Active</span>
          </div>

          <div style="text-align: center; padding: var(--space-sm); color: var(--text-muted);">
            <span style="font-size: 1.5rem;">‚Üì</span>
            <div style="font-size: 0.75rem;">Embedding Pipeline</div>
          </div>

          <div class="memory-layer chroma" id="layerChroma">
            <div class="memory-layer-icon" style="background: rgba(59, 130, 246, 0.2);">üî∑</div>
            <div class="memory-layer-info">
              <div class="memory-layer-name">Layer 2: Chroma Vectors</div>
              <div class="memory-layer-desc">Local semantic search with embeddings</div>
            </div>
            <span class="badge badge-info" id="chromaStatus">Local</span>
          </div>

          <div style="text-align: center; padding: var(--space-sm); color: var(--text-muted);">
            <span style="font-size: 1.5rem;">‚Üì</span>
            <div style="font-size: 0.75rem;">Hybrid Search</div>
          </div>

          <div class="memory-layer azure" id="layerAzure">
            <div class="memory-layer-icon" style="background: rgba(139, 92, 246, 0.2);">‚òÅÔ∏è</div>
            <div class="memory-layer-info">
              <div class="memory-layer-name">Layer 3: Azure AI Search</div>
              <div class="memory-layer-desc">Enterprise-grade semantic + keyword search</div>
            </div>
            <span class="badge badge-neutral" id="azureStatus">Cloud</span>
          </div>
        </div>

        <div class="mt-lg">
          <h4>Current Backend</h4>
          <p class="text-secondary" id="backendInfo">Loading...</p>
        </div>
      </div>

      <!-- Query Playground -->
      <div class="card">
        <h2 style="margin-bottom: var(--space-lg);">Query Playground</h2>
        <p class="text-secondary mb-md">Test semantic search and observe how queries flow through the memory layers.</p>

        <div class="mb-md">
          <input type="text" id="testQuery" class="input" placeholder="Try: 'thermal sensors for high temperature environments'">
        </div>

        <div class="flex gap-md mb-lg">
          <button id="runQuery" class="btn btn-primary">Run Query</button>
          <button id="clearResults" class="btn btn-outline">Clear</button>
        </div>

        <div id="queryResult" class="hidden">
          <h4>Query Analysis</h4>
          <div class="table-container mt-sm">
            <table class="table">
              <tbody>
                <tr>
                  <td style="width: 140px;">Intent Detected</td>
                  <td><span id="resultIntent" class="badge badge-info">-</span></td>
                </tr>
                <tr>
                  <td>Results Found</td>
                  <td><span id="resultCount">-</span></td>
                </tr>
                <tr>
                  <td>Query Time</td>
                  <td><span id="resultTime">-</span></td>
                </tr>
                <tr>
                  <td>Top Score</td>
                  <td><span id="resultScore">-</span></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-md">
            <h4>AI Reasoning</h4>
            <p id="resultReasoning" class="text-secondary" style="font-style: italic;">-</p>
          </div>

          <div class="mt-md" id="resultMatches"></div>
        </div>
      </div>
    </div>

    <!-- Educational Content Row -->
    <div class="grid grid-3 mb-lg">
      <!-- How Embeddings Work -->
      <div class="card">
        <h3 style="color: var(--primary-light); margin-bottom: var(--space-md);">üßÆ How Embeddings Work</h3>
        <p class="text-secondary" style="font-size: 0.875rem; line-height: 1.6;">
          Text embeddings convert words into high-dimensional vectors (1536 dimensions for ada-002).
          Similar concepts cluster together in this vector space, enabling semantic search.
        </p>
        <div class="mt-md" style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
          <div style="color: var(--success);">"thermal sensor"</div>
          <div style="color: var(--text-muted);">‚Üì text-embedding-ada-002</div>
          <div style="color: var(--primary-light);">[0.023, -0.041, 0.089, ...]</div>
        </div>
      </div>

      <!-- Semantic vs Keyword Search -->
      <div class="card">
        <h3 style="color: var(--primary-light); margin-bottom: var(--space-md);">üîç Semantic vs Keyword</h3>
        <p class="text-secondary" style="font-size: 0.875rem; line-height: 1.6;">
          Keyword search matches exact terms. Semantic search understands meaning -
          "temperature monitoring" finds "thermal sensors" even without matching words.
        </p>
        <div class="mt-md">
          <div class="flex gap-sm mb-sm">
            <span class="badge badge-neutral">Keyword</span>
            <span class="text-muted" style="font-size: 0.75rem;">"thermal" ‚Üí exact match only</span>
          </div>
          <div class="flex gap-sm">
            <span class="badge badge-success">Semantic</span>
            <span class="text-muted" style="font-size: 0.75rem;">"heat detection" ‚Üí thermal, temperature...</span>
          </div>
        </div>
      </div>

      <!-- LangGraph Flow -->
      <div class="card">
        <h3 style="color: var(--primary-light); margin-bottom: var(--space-md);">üîÑ LangGraph RAG Flow</h3>
        <p class="text-secondary" style="font-size: 0.875rem; line-height: 1.6;">
          Queries flow through a 5-node graph: intent classification, retrieval, context compression,
          LLM reasoning, and response formatting.
        </p>
        <div class="mt-md" style="font-size: 0.75rem;">
          <div class="flex gap-sm" style="flex-wrap: wrap;">
            <span class="badge badge-info">1. Parse Intent</span>
            <span style="color: var(--text-muted);">‚Üí</span>
            <span class="badge badge-info">2. Retrieve</span>
            <span style="color: var(--text-muted);">‚Üí</span>
            <span class="badge badge-info">3. Compress</span>
            <span style="color: var(--text-muted);">‚Üí</span>
            <span class="badge badge-warning">4. Reason</span>
            <span style="color: var(--text-muted);">‚Üí</span>
            <span class="badge badge-success">5. Respond</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Query History -->
    <div class="card">
      <div class="card-header">
        <h2>Query History</h2>
        <button id="clearHistory" class="btn btn-outline btn-sm">Clear History</button>
      </div>
      <p class="text-secondary mb-md">Watch queries flow through the system in real-time. Each row shows timing breakdowns by stage.</p>

      <div class="hit-log" id="queryHistory">
        <div class="text-muted" style="padding: var(--space-lg); text-align: center;">
          No queries yet. Try the playground above!
        </div>
      </div>
    </div>

    <!-- Chunking Explanation -->
    <div class="card mt-lg">
      <h2 style="margin-bottom: var(--space-lg);">Understanding Context Windows & Chunking</h2>
      <div class="grid grid-2" style="gap: var(--space-xl);">
        <div>
          <h4 style="color: var(--warning); margin-bottom: var(--space-md);">Why Chunk Documents?</h4>
          <p class="text-secondary" style="font-size: 0.875rem; line-height: 1.7;">
            LLMs have limited context windows (e.g., 128K tokens for GPT-4). Large documents must be split into
            smaller chunks for embedding and retrieval. Each schematic in our system is already chunk-sized,
            but in production RAG systems, you'd split longer documents.
          </p>
          <div class="mt-md" style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md);">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: var(--space-sm);">Typical Chunk Sizes:</div>
            <div class="flex gap-md">
              <div>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--success);">512</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">tokens (fast)</div>
              </div>
              <div>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--warning);">1024</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">tokens (balanced)</div>
              </div>
              <div>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--info);">2048</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">tokens (context-rich)</div>
              </div>
            </div>
          </div>
        </div>

        <div>
          <h4 style="color: var(--warning); margin-bottom: var(--space-md);">Overlap Strategy</h4>
          <p class="text-secondary" style="font-size: 0.875rem; line-height: 1.7;">
            Chunks often overlap (e.g., 10-20%) to preserve context at boundaries. This ensures important
            information isn't lost when a concept spans two chunks.
          </p>
          <div class="mt-md" style="font-family: var(--font-mono); font-size: 0.75rem; background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md);">
            <div style="color: var(--info);">Chunk 1: [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà<span style="color: var(--warning);">‚ñà‚ñà‚ñà‚ñà</span>]</div>
            <div style="color: var(--info);">Chunk 2: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: var(--warning);">[‚ñà‚ñà‚ñà‚ñà</span>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà]</div>
            <div style="color: var(--text-muted); margin-top: var(--space-sm);">‚Üë overlap preserves context</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer style="text-align: center; padding: var(--space-lg); color: var(--text-muted); font-size: 0.875rem;">
    WARNERCO Robotics Schematica &copy; 2025 | Educational Demonstration
  </footer>

  <script>
    const API_BASE = '/api';
    let queryHistory = [];
    let totalLatency = 0;
    let queryCount = 0;

    document.addEventListener('DOMContentLoaded', async () => {
      await loadStats();
      setupEventListeners();
    });

    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/memory/stats`);
        const stats = await res.json();

        document.getElementById('totalDocs').textContent = stats.total_schematics || 0;
        document.getElementById('backendInfo').innerHTML = `
          <strong>Active Backend:</strong> ${stats.backend || 'Unknown'}<br>
          <strong>Categories:</strong> ${Object.keys(stats.categories || {}).length}<br>
          <strong>Status Distribution:</strong> ${formatStatusCounts(stats.status_counts)}
        `;

        // Update layer status based on backend
        updateLayerStatus(stats.backend);
      } catch (err) {
        console.error('Failed to load stats:', err);
        document.getElementById('backendInfo').textContent = 'Failed to load backend info';
      }
    }

    function formatStatusCounts(counts) {
      if (!counts) return 'N/A';
      return Object.entries(counts)
        .map(([k, v]) => `${k}: ${v}`)
        .join(', ');
    }

    function updateLayerStatus(backend) {
      const jsonLayer = document.getElementById('layerJson');
      const chromaLayer = document.getElementById('layerChroma');
      const azureLayer = document.getElementById('layerAzure');

      // Reset all
      [jsonLayer, chromaLayer, azureLayer].forEach(l => l.style.opacity = '0.5');

      // Highlight active
      jsonLayer.style.opacity = '1'; // JSON always active

      if (backend === 'chroma') {
        chromaLayer.style.opacity = '1';
        document.getElementById('chromaStatus').textContent = 'Active';
        document.getElementById('chromaStatus').className = 'badge badge-success';
      } else if (backend === 'azure_search') {
        azureLayer.style.opacity = '1';
        document.getElementById('azureStatus').textContent = 'Active';
        document.getElementById('azureStatus').className = 'badge badge-success';
      }
    }

    async function runQuery() {
      const query = document.getElementById('testQuery').value.trim();
      if (!query) return;

      const resultDiv = document.getElementById('queryResult');
      resultDiv.classList.remove('hidden');

      // Show loading state
      document.getElementById('resultIntent').textContent = 'Processing...';
      document.getElementById('resultCount').textContent = '-';
      document.getElementById('resultTime').textContent = '-';
      document.getElementById('resultScore').textContent = '-';
      document.getElementById('resultReasoning').textContent = 'Analyzing...';
      document.getElementById('resultMatches').innerHTML = '';

      const startTime = performance.now();

      try {
        const res = await fetch(`${API_BASE}/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, top_k: 5 })
        });

        const data = await res.json();
        const endTime = performance.now();
        const clientTime = (endTime - startTime).toFixed(0);

        // Update stats
        queryCount++;
        totalLatency += parseFloat(data.query_time_ms || clientTime);
        document.getElementById('queryCount').textContent = queryCount;
        document.getElementById('avgLatency').textContent = (totalLatency / queryCount).toFixed(0);

        // Update results
        document.getElementById('resultIntent').textContent = data.intent || 'search';
        document.getElementById('resultIntent').className = `badge badge-${getIntentBadge(data.intent)}`;
        document.getElementById('resultCount').textContent = data.total_matches || 0;
        document.getElementById('resultTime').textContent = `${(data.query_time_ms || clientTime).toFixed(0)}ms (server) / ${clientTime}ms (client)`;
        document.getElementById('resultScore').textContent = data.results?.[0]?.score
          ? `${(data.results[0].score * 100).toFixed(1)}%`
          : 'N/A';
        document.getElementById('resultReasoning').textContent = data.reasoning || 'No reasoning available';

        // Show top matches
        if (data.results && data.results.length > 0) {
          document.getElementById('resultMatches').innerHTML = `
            <h4 class="mt-md">Top Matches</h4>
            <div class="mt-sm">
              ${data.results.slice(0, 3).map(r => `
                <div class="search-result">
                  <div class="flex flex-between">
                    <div>
                      <span class="schematic-model">${r.model}</span>
                      <strong style="margin-left: var(--space-sm);">${r.name}</strong>
                    </div>
                    <span class="search-score">${(r.score * 100).toFixed(1)}%</span>
                  </div>
                  <p class="text-muted" style="margin: var(--space-sm) 0 0; font-size: 0.875rem;">${r.summary?.substring(0, 100)}...</p>
                </div>
              `).join('')}
            </div>
          `;
        }

        // Add to history
        addToHistory({
          query,
          intent: data.intent,
          results: data.total_matches,
          time: data.query_time_ms || clientTime,
          timings: data.timings
        });

      } catch (err) {
        console.error('Query failed:', err);
        document.getElementById('resultReasoning').textContent = `Error: ${err.message}`;
      }
    }

    function getIntentBadge(intent) {
      return {
        lookup: 'warning',
        diagnostic: 'danger',
        analytics: 'info',
        search: 'success'
      }[intent] || 'neutral';
    }

    function addToHistory(entry) {
      queryHistory.unshift({
        ...entry,
        timestamp: new Date().toLocaleTimeString()
      });

      if (queryHistory.length > 20) queryHistory.pop();

      renderHistory();
    }

    function renderHistory() {
      const container = document.getElementById('queryHistory');

      if (queryHistory.length === 0) {
        container.innerHTML = '<div class="text-muted" style="padding: var(--space-lg); text-align: center;">No queries yet. Try the playground above!</div>';
        return;
      }

      container.innerHTML = queryHistory.map(h => `
        <div class="hit-entry">
          <span class="hit-time">${h.timestamp}</span>
          <span class="hit-query">${truncate(h.query, 40)}</span>
          <span class="badge badge-${getIntentBadge(h.intent)}" style="min-width: 70px; justify-content: center;">${h.intent}</span>
          <span class="hit-results">${h.results} results</span>
          <span class="hit-duration">${parseFloat(h.time).toFixed(0)}ms</span>
          ${h.timings ? `
            <span class="text-muted" style="font-size: 0.7rem; margin-left: var(--space-sm);">
              [parse: ${h.timings.parse_intent?.toFixed(0) || '-'}ms,
               retrieve: ${h.timings.retrieve?.toFixed(0) || '-'}ms,
               reason: ${h.timings.reason?.toFixed(0) || '-'}ms]
            </span>
          ` : ''}
        </div>
      `).join('');
    }

    function truncate(str, len) {
      return str && str.length > len ? str.substring(0, len) + '...' : str;
    }

    function setupEventListeners() {
      document.getElementById('runQuery').addEventListener('click', runQuery);
      document.getElementById('testQuery').addEventListener('keypress', e => {
        if (e.key === 'Enter') runQuery();
      });

      document.getElementById('clearResults').addEventListener('click', () => {
        document.getElementById('queryResult').classList.add('hidden');
        document.getElementById('testQuery').value = '';
      });

      document.getElementById('clearHistory').addEventListener('click', () => {
        queryHistory = [];
        renderHistory();
      });
    }
  </script>
</body>
</html>
